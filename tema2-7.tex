% TODO añadir resumen al principio de la segunda hora
% TODO añadir resumen al final
% TODO tildes dentro de lstlistings

\documentclass[hyperref={pdfpagelabels=false},tree-dvips]{beamer}
% By  using hyperref={pdfpagelabels=false} you get rid off:
%	Package hyperref Warning: Option `pdfpagelabels' is turned off
%	(hyperref)                because \thepage is undefined.
%	Hyperref stopped early

%\usetheme{Madrid}
\usetheme{Warsaw} %muestra las secciones, pero ocupa mucho espacio

%\setbeameroption{show notes}
%\setbeameroption{hide notes} % default
%\setbeameroption{show notes on second screen=left}
%\setbeameroption{show only notes} % for printing the notes only

\usepackage[spanish]{babel}
\selectlanguage{spanish}
\usepackage[utf8]{inputenc}

\usepackage{adjustbox}
\usepackage{graphicx}

\usepackage{qtree}
%\usepackage{tree-dvips}
% para que funcionen las anotaciones en los arboles de tree-dvips hay que compilar a dvi, no usar pdflatex. Y luego de dvi, pasar a pdf.

\usepackage{xcolor}
\definecolor{green}{RGB}{0,170,0} % redefine green for visibility

\usepackage{bold-extra} % for having boldfaced monospaced font in listings
\usepackage{listings}
% para no perder los tabs en los listings:
% https://tex.stackexchange.com/questions/8370/how-to-prevent-beamer-from-removing-the-tab-alignment-of-lstlisting
\lstdefinestyle{procesos}{
	language=C,
	emptylines=1,
	breaklines=true,
	basicstyle=\ttfamily\bfseries\color{black},
	moredelim=**[is][\color{red}]{@red@}{@},
	moredelim=**[is][\color{blue}]{@blue@}{@},
	moredelim=**[is][\color{green}]{@green@}{@},
}
\lstdefinestyle{codigo}{
	language=C,
	emptylines=1,
	breaklines=true,
	basicstyle=\tiny\ttfamily\color{black},
	%numbers=left,
	columns=fullflexible,
	keepspaces=true,
	tabsize=3,
	morecomment=[l]{//},
	moredelim=**[is][\color{red}]{@red@}{@},
	moredelim=**[is][\color{blue}]{@blue@}{@},
	moredelim=**[is][\color{green}]{@green@}{@},
	tabsize=2,
	showtabs
}
\lstdefinestyle{codigoMP}{
	language=C,
	morekeywords={fun,ffun,cons,devuelve},
	keywordstyle=\itshape\color{black},
	emptylines=1,
	breaklines=true,
	basicstyle=\small\ttfamily,
	numbers=left,
	columns=fullflexible,
	keepspaces=true,
	tabsize=3,
	morecomment=[l]{//},
	commentstyle=\color{gray},
	moredelim=**[is][\color{red}]{@red@}{@},
	moredelim=**[is][\color{green}]{@green@}{@},
	moredelim=**[is][\bfseries]{@b@}{@},
	tabsize=2,
	showtabs
}
\lstdefinestyle{gramaticas}{
	language=C,
	emptylines=1,
	breaklines=true,
	basicstyle=\ttfamily\color{black},
	moredelim=**[is][\color{red}]{@red@}{@},
	moredelim=**[is][\color{blue}]{@blue@}{@},
	moredelim=**[is][\color{green}]{@green@}{@},
}

\usepackage{tikz}
\usetikzlibrary{arrows,calc,shapes,decorations.pathreplacing,positioning}

\usepackage{bytefield}
	\newcommand{\colorbitbox}[3]{%
	\rlap{\bitbox{#2}{\color{#1}\rule{\width}{\height}}}%
	\bitbox{#2}{#3}}
	\definecolor{lightcyan}{rgb}	{0.80, 	0.90   , 1   }
	\definecolor{lightgreen}{rgb}	{0.50, 	1   , 0.50}
	\definecolor{lightred}{rgb}		{1   , 	0.70, 0.71}
	\definecolor{lightblue}{rgb}	{0   , 	0.90, 1   }




\title{Tema 2.7. Subprogramas. Traducción}
\author{Pedro Javier Rodríguez Rodrigo, Víctor Cuadrado Juan}
%Basado en las trasparencias de José Luis Sierra y Juan Antonio Recio.}
\date{\today}

\begin{document}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}
\titlepage
\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Organización de la memoria}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Organización de la memoria}
\note{Talk no more than 1 minute.}

\begin{itemize}[<+->]% [<+->] makes it uncoverable
	\item Es posible acceder a los datos globales
	\item Desde cualquier registro de activación es necesario referir al registro de activación asociado con el bloque padre (que no tiene porque ser necesariamente el registro de activación anterior)
	\item Dos Posibles organizaciones:
		\begin{enumerate}[<+->]
			\item Enlaces estáticos
			\item Displays
		\end{enumerate}
\end{itemize}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Enlaces estáticos}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Enlaces estáticos}
\begin{itemize}%[<+->]% [<+->] makes it uncoverable
	\item En el registro de activación se incluye un enlace al registro de activación del bloque padre (enlace estático)
	\item La memoria se organiza en forma de pila de registros de activación, enlazados a través de los enlaces estáticos
\end{itemize}
\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile] % fragile: needed for verbatim/lstlistings
\frametitle{Enlaces estáticos: Ejemplo}

\begin{columns}[T]
\column{.4\textwidth}
	\begin{lstlisting}[style=procesos]
	@red@proc proc1(){
	    x: num;
	    y: num;
	    proc1();
	}@
	@blue@proc proc2(){
	    w: bool;
	    proc1();
	}@
	@green@main(){
	    a: bool;
	    proc2();
	}@
	\end{lstlisting}
\column{.3\textwidth}
	\begin{tikzpicture}
	  \begin{scope}[every node/.style={draw, anchor=text, rectangle split,
	    rectangle split parts=12,minimum width=2cm,
	    rectangle split part fill={gray!20,red!40,red!40,red!40,red!40,
	    blue!40,blue!40,blue!40,green!40,green!40,green!40,gray!20}}]
	    \node (Inst) at (2,4){
	    	\nodepart{one}...
	    	\nodepart{two}\small{def proc1()}
	    	\nodepart{three}\small{x: num}
	    	\nodepart{four}\small{y: num}
	    	\nodepart{five}\small{proc1()}
	    	\nodepart{six}\small{def proc2()}
	    	\nodepart{seven}\small{w: bool}
	    	\nodepart{eight}\small{proc1()}
	    	\nodepart{nine}\small{def main()}
	    	\nodepart{ten}\small{a: bool}
	    	\nodepart{eleven}\small{proc2()}
	    	\nodepart{twelve}...
	    };
	  \end{scope}
	\end{tikzpicture}
\column{.3\textwidth}
	\begin{center}
		\begin{tikzpicture}
		  \begin{scope}[every node/.style={draw, anchor=text, rectangle split,
		    rectangle split parts=10,minimum width=2cm,
		    rectangle split part fill={gray!20,red!40,red!40,red!40,red!40,red!40,red!40,
		    blue!40,blue!40,green!40}}]
		    \node (Reg) at (2,4){
		    	\nodepart{one}...
		    	\nodepart{two}y
		    	\nodepart{three}x
		    	\nodepart{four}padre
		    	\nodepart{five}y
		    	\nodepart{six}x
		    	\nodepart{seven}padre
		        \nodepart{eight}w
		        \nodepart{nine}padre
		        \nodepart{ten}a
		    };
		  \end{scope}
		  \draw[-latex] (Reg.four west) to [out=225,in=135] (Reg.seven west);
		  \draw[-latex] (Reg.seven west) to [out=225,in=135] (Reg.nine west);
		  \draw[-latex] (Reg.nine west) to [out=225,in=135] (Reg.ten west);
		\end{tikzpicture}
	\end{center}
\end{columns}
\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Enlaces estáticos: Problemas}

\uncover<1->{¿Qué problemas hay?}

\begin{enumerate}%[<+->]% [<+->] makes it uncoverable
	\item<2-> La recuperación del enlace de un identificador global supone seguir toda la cadena de enlaces estáticos. Si el identificador ha sido declarado \emph{k} niveles por encima, es necesario realizar \emph{k} indirecciones hasta llegar al correspondiente registro de activación
	\item<3-> Hay que considerar la complejidad de generar código que gestione de manera adecuada los enlaces estáticos
\end{enumerate}

\uncover<4->{Solución:\\
Almacenar los enlaces estáticos \emph{fuera} de los registros de activación. La estructura que los almacena se llama \textbf{display}.}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Displays}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Display}

\begin{itemize}[<+->]% [<+->] makes it uncoverable
	\item Secuencia de celdas consecutivas que apuntan a registros de activación
	\item La celda \emph{i} apunta al registro de activación que está siendo utilizado en el nivel de anidamiento \emph{i}
	\item Esta estructura facilita el acceso a los datos globales:\\
		el enlace para un identificador declarado en un bloque que se encuentra a profunidad \emph{i} estará en el registro de activación referido por la celda \emph{i} del display (el \emph{display i} a partir de ahora)
\end{itemize}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Display: Ejemplo}

\begin{columns}[T]
\column{.4\textwidth}
	\begin{lstlisting}[style=procesos]
	@red@proc proc1(){
	    x: num;
	    y: num;
	    proc1();
	}@
	@blue@proc proc2(){
	    w: bool;
	    proc1();
	}@
	@green@main(){
	    a: bool;
	    proc2();
	}@
	\end{lstlisting}
\column{.6\textwidth}
	\begin{center}
		\begin{tikzpicture}
		  \begin{scope}
			  	[every node/.style={rectangle split, draw, anchor=text,
			    rectangle split parts=7,minimum width=2cm,
			    rectangle split part fill={gray!20,red!40,red!40,red!40,red!40,
			    blue!40,green!40}}]
		    \node (Reg) at (3,-1.5){
		    	\nodepart{one}...
		    	\nodepart{two}y
		    	\nodepart{three}x
		    	\nodepart{four}y
		    	\nodepart{five}x
		        \nodepart{six}w
		        \nodepart{seven}a
		    };
		  \end{scope}

		  \begin{scope}[every node/.style={draw, rectangle, node distance=0pt, outer sep=0pt}]
			  \node (A) at (0,0) {0};
			  \node [right = of A] (B) {1};
			  \node [right = of B] (C) {2};
			  \node [right = of C] (D) {3};
		  \end{scope}

		  \draw[-latex] (A.south) to [out=270,in=180] (Reg.seven west);
		  \draw[-latex] (B.south) to [out=270,in=180] (Reg.six west);
		  \draw[-latex] (C.south) to [out=270,in=180] (Reg.five west);
		  \draw[-latex] (D.south) to [out=270,in=180] (Reg.three west);
		\end{tikzpicture}
	\end{center}
\end{columns}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Nueva arquitectura para la MV}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Memoria de un programa I}

	\begin{tikzpicture}
		[box/.style={draw, node distance=0pt, outer sep=0pt, minimum height=4em}]
		
		\node[box, fill=red!40] at (0,0) (A) {CP};
		\node[box, right = of A, fill=green!40, minimum width=4em] (B) {Displays};
		\node[box, right = of B, text width=5em, align=center, fill=blue!40] (C) {Datos estáticos};
		\node[box, right = of C, minimum width=12em] (D) {\ldots};
		\node[box, right = of D, minimum width=3em, fill=lime!40] (E) {Heap};
		
		\draw[-latex, thick] (C.east) -- ( $(C.east)!0.7cm!(D)$);
		\draw[-latex, thick] (E.west) -- ( $(E.west)!0.7cm!(D)$);

		\node[above = of A.north west, anchor=west, xshift=.5cm] (etqA) {0x0000000};
		\draw[-latex] (etqA.west) to [out=180, in=90] (A.north west);
		\node[above = of E.north east, anchor=east, xshift=-.5cm] (etqB) {0xFFFFFFFF};
		\draw[-latex] (etqB.east) to [out=0, in=90] (E.north east);

		\draw[-latex, dashed] (A.south) |- ($(C.south east)-(0,0.5)$) -- (C.south east);

	\end{tikzpicture}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Memoria de un programa II}

Las primeras celdas de la memoria se destinarán a mantener la información de estado necesaria para gestionar adecuadamente la pila de registros de activación:
\begin{itemize}[<+->]% [<+->] makes it uncoverable
	\item Registro \emph{CP}: Contendrá siempre la dirección de la \textbf{última celda ocupada} por la pila de registros de activación (cuando la pila esté vacía, el valor de \emph{CP} será la dirección de la celda anterior -la última celda ocupada por el display-)
	\item \emph{Display}
\end{itemize}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Estructura de los Registros de activación}

dibujo del registro de activación

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Organización de la traducción}
\subsection{Inicio}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Inicio}

\begin{itemize}[<+->]% [<+->] makes it uncoverable
	\item Se fija el \emph{display 0} a la primera celda de datos estáticos
	\item Se fija el \emph{CP} a la posición de la última celda del display (la última celda ocupada)
	\item Con ello se consigue un esquema homogéneo de direccionamiento de datos estáticos y de datos en los registros de activación
\end{itemize}

dibujo

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Inicio}
\begin{lstlisting}[style=codigoMP]
fun inicio(numNiveles,tamDatos) devuelve
   // fijamos display 0 a la 1a celda de datos estaticos:
   apila(numNiveles+2)           ||// +2: CP, display 0
   desapila-dir(1)               ||
   // fijamos CP a la ultima celda de datos estaticos:
   apila(1+numNiveles+tamDatos)  ||// +1: display 0
   desapila-dir(0)
ffun
cons longInicio = 4
\end{lstlisting}

Ejemplo: inicio(2,5)

Dibujo del movimiento del cp

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Ejemplo de invocación}

\begin{columns}[T]
\column{.5\textwidth}
\begin{lstlisting}[style=codigo]
	tipo tpar= rec x:num; y:num;
	@red@proc distanciaEuclidea(p1:tpar, p2:tpar, var res:num)
	    a: num; b: num;@
	    @blue@proc sumacuadrado(a:num, b:num, var r:num)
            a:=a*a;
	        b:=b*b
	        r:=a+b;@
	    @green@proc raizcuadrada(var n:num)
	        ...@
	    @red@&
	    a:=p1.x-p2.x;
	    b:=p1.y-p2.y;
	    sumacuadrado(a, b, res);
	    raizcuadrada(res);@
	par1:tpar; par2:tpar; resultado:num;
	&
	par1.x:=1; par1.y:=5;
	par2.x:=8; par2.y:=12;
	distanciaEuclidea(par1,par2,resultado);
\end{lstlisting}
\column{.5\textwidth}
	\uncover<2->{
			\Tree
			[.main()
			    [.{\color{red}distanciaEuclidea()}
			        [.{\color{blue}sumaCuadrado()}  ]
			        [.{\color{green}raizCuadrada()} ]
			    ]
			]
	}
\end{columns}
\uncover<1->{¿Cual es el máximo nivel de anidamiento para éste programa?}
\uncover<2->{2}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Esquema de la traducción de subprogramas}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Esquema de la traducción}

Dibujo de cómo queda la traducción de subprogramas y el main, y el salto con ir-a.

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Manejo de la activación y desactivación I}

dibujo con la explicación de ir-ind

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Manejo de la activación y desactivación II}

orden de la ejecución del código generado

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Prellamada}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Prellamada}

Asociada con la invocación $p(e_1,...,e_k)$:
\begin{enumerate}[<+->]
	\item
	\item
	\item
\end{enumerate}

dibujo de lo que aparece al hacer los pasos


\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Prellamada: Ejemplo}

\begin{lstlisting}[style=codigoMP]
fun apila-ret(ret) devuelve
   // calcular CP+1:
   apila-dir(0)          ||
   apila(1)              ||
   suma                  ||
   // guardar dir retorno:
   apila(ret)            ||
   desapila-ind          ||
ffun
cons longApilaRet = 5
\end{lstlisting}

Ejemplo: apila-ret(0x527) , siendo 0x527 el nº de instrucción.

Dibujo

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Prólogo}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Prólogo I}

Asociado con el prodecimiento $proc p(...)$:
\begin{enumerate}[<+->]
	\item
	\item
	\item
\end{enumerate}

dibujo de lo que aparece al hacer los pasos

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Prólogo II}

\begin{lstlisting}[style=codigoMP,basicstyle=\scriptsize\ttfamily]
fun prologo(nivel,tamlocales) devuelve
   // salvar display antiguo:
   apila-dir(0)          ||
   apila(2)              ||
   suma                  ||
   apila-dir(1+nivel)    ||
   desapila-ind          ||
   // fijar el display actual:
   apila-dir(0)          ||
   apila(3)              ||
   suma                  ||
   desapila-dir(1+nivel) ||
   // reservar espacio para datos locales:
   apila-dir(0)          ||
   apila(tamlocales+2)   ||
   suma                  ||
   desapila-dir(0)
ffun
cons longPrologo = 13
\end{lstlisting}


\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Prólogo: Ejemplo I}

\begin{lstlisting}[style=codigoMP,basicstyle=\tiny\ttfamily]
fun prologo(nivel,tamlocales) devuelve
   // salvar display antiguo:
   @b@apila-dir(0)          ||@
   @b@apila(2)              ||@ // dir. retorno, antiguo display
   @b@suma                  ||@
   @b@apila-dir(1+nivel)    ||@ // +1: saltar al display 0
   @b@desapila-ind          ||@
   // fijar el display actual:
   apila-dir(0)          ||
   apila(3)              ||
   suma                  ||
   desapila-dir(1+nivel) ||
   // reservar espacio para datos locales:
   apila-dir(0)          ||
   apila(tamlocales+2)   ||
   suma                  ||
   desapila-dir(0)
ffun
\end{lstlisting}

Ejemplo: prologo(1,7)

Dibujo

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Prólogo: Ejemplo II}

\begin{lstlisting}[style=codigoMP,basicstyle=\tiny\ttfamily]
fun prologo(nivel,tamlocales) devuelve
   // salvar display antiguo:
   apila-dir(0)          ||
   apila(2)              || // dir. retorno, antiguo display
   suma                  ||
   apila-dir(1+nivel)    || // +1: saltar al display 0
   desapila-ind          ||
   // fijar el display actual:
   @b@apila-dir(0)          ||@
   @b@apila(3)              ||@
   @b@suma                  ||@
   @b@desapila-dir(1+nivel) ||@
   // reservar espacio para datos locales:
   apila-dir(0)          ||
   apila(tamlocales+2)   ||
   suma                  ||
   desapila-dir(0)
ffun
\end{lstlisting}

Ejemplo: prologo(1,7)

Dibujo

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Prólogo: Ejemplo III}

\begin{lstlisting}[style=codigoMP,basicstyle=\tiny\ttfamily]
fun prologo(nivel,tamlocales) devuelve
   // salvar display antiguo:
   apila-dir(0)          ||
   apila(2)              || // dir. retorno, antiguo display
   suma                  ||
   apila-dir(1+nivel)    || // +1: saltar al display 0
   desapila-ind          ||
   // fijar el display actual:
   apila-dir(0)          ||
   apila(3)              ||
   suma                  ||
   desapila-dir(1+nivel) ||
   // reservar espacio para datos locales:
   @b@apila-dir(0)          ||@ // Mem[1+nivel] = Pila[Cima]
   @b@apila(tamlocales+2)   ||@ // +2: dir. retorno, antiguo display
   @b@suma                  ||@
   @b@desapila-dir(0)         @
ffun
\end{lstlisting}

Ejemplo: prologo(1,7)

Dibujo

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Epílogo}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Epílogo I}

Asociado con el prodecimiento $proc p(...)$:
\begin{enumerate}[<+->]
	\item
	\item
	\item
\end{enumerate}

dibujo de lo que aparece al hacer los pasos

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Epílogo II}
\begin{lstlisting}[style=codigoMP,basicstyle=\scriptsize\ttfamily]
fun epilogo(nivel) devuelve
   // apilar la dir. retorno:
   apila-dir(1+nivel)    ||
   apila(2)              ||
   resta                 ||
   apila-ind             ||
   // liberar espacio (mover CP):
   apila-dir(1+nivel)    ||
   apila(3)              ||
   resta                 ||
   copia                 ||
   desapila-dir(0)       ||
   // recupear antiguo display:
   apila(2)              ||
   suma                  ||
   apila-ind             ||
   desapila-dir(1+nivel)
ffun
cons longEpilogo = 13
\end{lstlisting}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Epílogo: Ejemplo I}

\begin{lstlisting}[style=codigoMP,basicstyle=\tiny\ttfamily]
fun epilogo(nivel) devuelve
   // apilar la dir. retorno:
   @b@apila-dir(1+nivel)    ||@
   @b@apila(2)              ||@
   @b@resta                 ||@
   @b@apila-ind             ||@
   // liberar espacio (mover CP):
   apila-dir(1+nivel)    ||
   apila(3)              ||
   resta                 ||
   copia                 ||
   desapila-dir(0)       ||
   // recupear antiguo display:
   apila(2)              ||
   suma                  ||
   apila-ind             ||
   desapila-dir(1+nivel)
ffun
\end{lstlisting}

Ejemplo: epilogo(1)

Dibujo

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Epílogo: Ejemplo II}

\begin{lstlisting}[style=codigoMP,basicstyle=\tiny\ttfamily]
fun epilogo(nivel) devuelve
   // apilar la dir. retorno:
   apila-dir(1+nivel)    ||
   apila(2)              ||
   resta                 ||
   apila-ind             ||
   // liberar espacio (mover CP):
   @b@apila-dir(1+nivel)    ||@
   @b@apila(3)              ||@
   @b@resta                 ||@
   @b@copia                 ||@ // si no se usa copia, hay que mover CP lo ultimo
   @b@desapila-dir(0)       ||@
   // recupear antiguo display:
   apila(2)              ||
   suma                  ||
   apila-ind             ||
   desapila-dir(1+nivel)
ffun
\end{lstlisting}

Ejemplo: epilogo(1)

¿Es la mejor forma de implementar el epílogo, con mover el CP en 2º lugar?

Dibujo

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Epílogo: Ejemplo III}

\begin{lstlisting}[style=codigoMP,basicstyle=\tiny\ttfamily]
fun epilogo(nivel) devuelve
   // apilar la dir. retorno:
   apila-dir(1+nivel)    ||
   apila(2)              ||
   resta                 ||
   apila-ind             ||
   // liberar espacio (mover CP):
   apila-dir(1+nivel)    ||
   apila(3)              ||
   resta                 ||
   copia                 ||
   desapila-dir(0)       ||
   // recupear antiguo display:
   @b@apila(2)              ||@
   @b@suma                  ||@
   @b@apila-ind             ||@
   @b@desapila-dir(1+nivel)   @
ffun
\end{lstlisting}

Ejemplo: epilogo(1)

Dibujo

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Postllamada}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Postllamada}

\begin{itemize}[<+->]
	\item No es necesaria en nuestra implementación, ya que el epílogo recupera el estado anterior a la invocación.
	\item Hemos terminado con la dirección (indirecta) de retorno en la cima de la pila
\end{itemize}
dibujo de la cima de la pila

dibujo de la memoria

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Resumen}

repetir dibujo del manejo de la activacion y la desactivacion

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Paso de parámetros}
\subsection{Por valor}
\subsection{Por referencia}
\subsection{Amplicación de la TS}
\subsection{Traducción}



% dentro de lstlisting, y por culpa de beamer, solo se pueden usar espacios y no tabs para indentar :(


\end{document}
