% TODO añadir resumen al principio de la segunda hora
% TODO añadir resumen al final
% TODO tildes dentro de lstlistings. dentro de lstlisting, y por culpa de beamer, solo se pueden usar espacios y no tabs para indentar :(

\documentclass[hyperref={pdfpagelabels=false},tree-dvips]{beamer}
% By  using hyperref={pdfpagelabels=false} you get rid off:
%	Package hyperref Warning: Option `pdfpagelabels' is turned off
%	(hyperref)                because \thepage is undefined.
%	Hyperref stopped early

%\usetheme{Madrid}
%\usetheme{Warsaw} %muestra las secciones, pero ocupa mucho espacio
%\usetheme{Madrid}
%\usetheme{Amsterdam}
%\usetheme{Darmstadt}

%\usetheme{CambridgeUS}
%\usecolortheme{whale}
%\usetheme{Frankfurt}
% lista de themes: http://www.hartwork.org/beamer-theme-matrix/


%\setbeameroption{show notes}
%\setbeameroption{hide notes} % default
%\setbeameroption{show notes on second screen=left}
%\setbeameroption{show only notes} % for printing the notes only

\usepackage[spanish]{babel}
\selectlanguage{spanish}
\usepackage[utf8]{inputenc}

\usepackage{adjustbox}
\usepackage{graphicx}

\usepackage{qtree}
%\usepackage{tree-dvips}
% para que funcionen las anotaciones en los arboles de tree-dvips hay que compilar a dvi, no usar pdflatex. Y luego de dvi, pasar a pdf.

\usepackage{xcolor}
\definecolor{green}{RGB}{0,170,0} % redefine green for visibility

\usepackage{bold-extra} % for having boldfaced monospaced font in listings
\usepackage{listings}
% para no perder los tabs en los listings:
% https://tex.stackexchange.com/questions/8370/how-to-prevent-beamer-from-removing-the-tab-alignment-of-lstlisting
\lstdefinestyle{procesos}{
	language=C,
	emptylines=1,
	breaklines=true,
	basicstyle=\ttfamily\bfseries\color{black},
	moredelim=**[is][\color{red}]{@red@}{@},
	moredelim=**[is][\color{violet}]{@vio@}{@},
	moredelim=**[is][\color{blue}]{@blue@}{@},
	moredelim=**[is][\color{green}]{@green@}{@},
}
\lstdefinestyle{codigo}{
	language=C,
	emptylines=1,
	breaklines=true,
	basicstyle=\tiny\ttfamily\color{black},
	%numbers=left,
	columns=fullflexible,
	keepspaces=true,
	tabsize=3,
	morecomment=[l]{//},
	moredelim=**[is][\color{red}]{@red@}{@},
	moredelim=**[is][\color{violet}]{@vio@}{@},
	moredelim=**[is][\color{blue}]{@blue@}{@},
	moredelim=**[is][\color{green}]{@green@}{@},
	moredelim=**[is][\bfseries]{@bold@}{@},
	tabsize=2,
	showtabs
}
\lstdefinestyle{codigoMP}{
	language=C,
	morekeywords={fun,ffun,cons,devuelve,si,no,sino,entonces},
	keywordstyle=\bfseries\color{black},
	emptylines=1,
	breaklines=true,
	basicstyle=\small\ttfamily,
	numbers=left,
	columns=fullflexible,
	keepspaces=true,
	tabsize=3,
	morecomment=[l]{//},
	commentstyle=\color{gray},
	moredelim=**[is][\color{red}]{@red@}{@},
	moredelim=**[is][\color{violet}]{@vio@}{@},
	moredelim=**[is][\color{green}]{@green@}{@},
	moredelim=**[is][\bfseries\color{blue}]{@b@}{@},
	tabsize=2,
	showtabs
}
\lstdefinestyle{gramaticas}{
	language=C,
	emptylines=1,
	breaklines=true,
	columns=fullflexible,
	keepspaces=true,
	tabsize=3,
	morekeywords={or,and,proc,iden,fproc,id,&,(,),if,then,while,do},
	keywordstyle=\itshape,
	basicstyle=\small\ttfamily,
	moredelim=**[is][\color{red}]{@red@}{@},
	moredelim=**[is][\color{magenta}]{@mag@}{@},
	moredelim=**[is][\color{blue}]{@blue@}{@},
	moredelim=**[is][\color{green}]{@green@}{@},
	moredelim=**[is][\bfseries\color{blue}]{@b@}{@},
	moredelim=**[is][\bfseries]{@bold@}{@}
}

\usepackage{tikz}
\usetikzlibrary{arrows,calc,shapes,decorations.pathreplacing,positioning}

\title{Tema 2.7. Subprogramas. Traducción}
\author{Pedro Javier Rodríguez Rodrigo, Víctor Cuadrado Juan}
%Basado en las trasparencias de José Luis Sierra y Juan Antonio Recio.}
\date{\today}

\begin{document}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}
\titlepage
\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Organización de la memoria}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Organización de la memoria}
\note{Talk no more than1minute.}

\begin{itemize}[<+->]% [<+->] makes it uncoverable
	\item Es posible acceder a los datos globales
	\item Desde cualquier registro de activación es necesario referir al registro de activación asociado con el bloque padre (que no tiene porque ser necesariamente el registro de activación anterior)
	\item Dos Posibles organizaciones:
		\begin{enumerate}[<+->]
			\item Enlaces estáticos
			\item Displays
		\end{enumerate}
\end{itemize}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Enlaces estáticos}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Enlaces estáticos}
\begin{itemize}%[<+->]% [<+->] makes it uncoverable
	\item En el registro de activación se incluye un enlace al registro de activación del bloque padre (enlace estático)
	\item La memoria se organiza en forma de pila de registros de activación, enlazados a través de los enlaces estáticos
\end{itemize}
\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile] % fragile: needed for verbatim/lstlistings
\frametitle{Enlaces estáticos: Ejemplo}

\begin{columns}[T]
\column{.4\textwidth}
	\begin{lstlisting}[style=procesos]
	@red@proc proc1(){
	    x: num;
	    y: num;@
	    @vio@proc1();@
	@red@}@
	@blue@proc proc2(){
	    w: bool;
	    proc1();
	}@
	@green@main(){
	    a: bool;
	    proc2();
	}@
	\end{lstlisting}
\column{.3\textwidth}
	\begin{tikzpicture}
	  \begin{scope}[every node/.style={draw, anchor=text, rectangle split,
	    rectangle split parts=12,minimum width=2cm,
	    rectangle split part fill={gray!20,red!40,red!40,red!40,violet!40,
	    blue!40,blue!40,blue!40,green!40,green!40,green!40,gray!20}}]
	    \node (Inst) at (2,4){
	    	\nodepart{one}...
	    	\nodepart{two}\small{def proc1()}
	    	\nodepart{three}\small{x: num}
	    	\nodepart{four}\small{y: num}
	    	\nodepart{five}\small{proc1()}
	    	\nodepart{six}\small{def proc2()}
	    	\nodepart{seven}\small{w: bool}
	    	\nodepart{eight}\small{proc1()}
	    	\nodepart{nine}\small{def main()}
	    	\nodepart{ten}\small{a: bool}
	    	\nodepart{eleven}\small{proc2()}
	    	\nodepart{twelve}...
	    };
	  \end{scope}
	\end{tikzpicture}
\column{.3\textwidth}
	\begin{center}
		\begin{tikzpicture}
		  \begin{scope}[every node/.style={draw, anchor=text, rectangle split,
		    rectangle split parts=10,minimum width=2cm,
		    rectangle split part fill={gray!20,violet!40,violet!40,violet!40,red!40,red!40,red!40,
		    blue!40,blue!40,green!40}}]
		    \node (Reg) at (2,4){
		    	\nodepart{one}...
		    	\nodepart{two}y
		    	\nodepart{three}x
		    	\nodepart{four}padre
		    	\nodepart{five}y
		    	\nodepart{six}x
		    	\nodepart{seven}padre
		        \nodepart{eight}w
		        \nodepart{nine}padre
		        \nodepart{ten}a
		    };
		  \end{scope}
		  \draw[-latex] (Reg.four west) to [out=225,in=135] (Reg.seven west);
		  \draw[-latex] (Reg.seven west) to [out=225,in=135] (Reg.nine west);
		  \draw[-latex] (Reg.nine west) to [out=225,in=135] (Reg.ten west);
		\end{tikzpicture}
	\end{center}
\end{columns}
\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Enlaces estáticos: Problemas}

\uncover<1->{¿Qué problemas hay?}

\begin{enumerate}%[<+->]% [<+->] makes it uncoverable
	\item<2-> La recuperación del enlace de un identificador global supone seguir toda la cadena de enlaces estáticos. Si el identificador ha sido declarado \emph{k} niveles por encima, es necesario realizar \emph{k} indirecciones hasta llegar al correspondiente registro de activación
	\item<3-> Hay que considerar la complejidad de generar código que gestione de manera adecuada los enlaces estáticos
\end{enumerate}

\uncover<4->{Solución:\\
Almacenar los enlaces estáticos \emph{fuera} de los registros de activación. La estructura que los almacena se llama \textbf{display}.}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Displays}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Display}

\begin{itemize}[<+->]% [<+->] makes it uncoverable
	\item Secuencia de celdas consecutivas que apuntan a registros de activación
	\item La celda \emph{i} apunta al registro de activación que está siendo utilizado en el nivel de anidamiento \emph{i}
	\item Esta estructura facilita el acceso a los datos globales:\\
		el enlace para un identificador declarado en un bloque que se encuentra a profunidad \emph{i} estará en el registro de activación referido por la celda \emph{i} del display (el \emph{display i} a partir de ahora)
\end{itemize}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Display: Ejemplo}

\begin{columns}[T]
\column{.4\textwidth}
	\begin{lstlisting}[style=procesos]
	@red@proc proc1(){
	    x: num;
	    y: num;@
	    @vio@proc1();@
	@red@}@
	@blue@proc proc2(){
	    w: bool;
	    proc1();
	}@
	@green@main(){
	    a: bool;
	    proc2();
	}@
	\end{lstlisting}
\column{.6\textwidth}
	\begin{center}
		\begin{tikzpicture}
		  \begin{scope}
			  	[every node/.style={rectangle split, draw, anchor=text,
			    rectangle split parts=7,minimum width=2cm,
			    rectangle split part fill={gray!20,violet!40,violet!40,red!40,red!40,
			    blue!40,green!40}}]
		    \node (Reg) at (3,-1.5){
		    	\nodepart{one}...
		    	\nodepart{two}y
		    	\nodepart{three}x
		    	\nodepart{four}y
		    	\nodepart{five}x
		        \nodepart{six}w
		        \nodepart{seven}a
		    };
		  \end{scope}

		  \begin{scope}[every node/.style={draw, rectangle, node distance=0pt, outer sep=0pt}]
			  \node (A) at (0,0) {0};
			  \node [right = of A] (B) {1};
			  \node [right = of B] (C) {2};
			  \node [right = of C] (D) {3};
		  \end{scope}

		  \draw[-latex] (A.south) to [out=270,in=180] (Reg.seven west);
		  \draw[-latex] (B.south) to [out=270,in=180] (Reg.six west);
		  \draw[-latex] (C.south) to [out=270,in=180] (Reg.five west);
		  \draw[-latex] (D.south) to [out=270,in=180] (Reg.three west);
		\end{tikzpicture}
	\end{center}
\end{columns}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Nueva arquitectura para la MV}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Memoria de un programa I}

	\begin{tikzpicture}
		[box/.style={draw, node distance=0pt, outer sep=0pt, minimum height=4em}]

		\node[box, fill=red!40] at (0,0) (A) {CP};
		\node[box, right = of A, fill=green!40, minimum width=4em] (B) {Displays};
		\node[box, right = of B, text width=5em, align=center, fill=blue!40] (C) {Datos estáticos};
		\node[box, right = of C, minimum width=12em] (D) {\ldots};
		\node[box, right = of D, minimum width=3em, fill=lime!40] (E) {Heap};

		\draw[-latex, thick] (C.east) -- ( $(C.east)!0.7cm!(D)$);
		\draw[-latex, thick] (E.west) -- ( $(E.west)!0.7cm!(D)$);

		\node[above = of A.north west, anchor=west, xshift=.5cm] (etqA) {0x0000000};
		\draw[-latex] (etqA.west) to [out=180, in=90] (A.north west);
		\node[above = of E.north east, anchor=east, xshift=-.5cm] (etqB) {0xFFFFFFFF};
		\draw[-latex] (etqB.east) to [out=0, in=90] (E.north east);

		\draw[-latex, dashed] (A.south) |- ($(C.south east)-(0,0.5)$) -- (C.south east);

	\end{tikzpicture}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Memoria de un programa II}

Las primeras celdas de la memoria se destinarán a mantener la información de estado necesaria para gestionar adecuadamente la pila de registros de activación:
\begin{itemize}[<+->]% [<+->] makes it uncoverable
	\item Registro \emph{CP}: Contendrá siempre la dirección de la \textbf{última celda ocupada} por la pila de registros de activación (cuando la pila esté vacía, el valor de \emph{CP} será la dirección de la celda anterior -la última celda ocupada por el display-)
	\item \emph{Display}
\end{itemize}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Estructura de los Registros de activación}

dibujo del registro de activación

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Organización de la traducción}
\subsection{Inicio}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Inicio}

\begin{itemize}[<+->]% [<+->] makes it uncoverable
	\item Se fija el \emph{display 0} a la primera celda de datos estáticos
	\item Se fija el \emph{CP} a la posición de la última celda del display (la última celda ocupada)
	\item Con ello se consigue un esquema homogéneo de direccionamiento de datos estáticos y de datos en los registros de activación
\end{itemize}

dibujo

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Inicio}
\begin{lstlisting}[style=codigoMP]
fun inicio(numNiveles,tamDatos) devuelve
   // fijamos display 0 a la 1a celda de datos estaticos:
   apila(numNiveles+2)           ||// +2: CP, display 0
   desapila-dir(1)               ||
   // fijamos CP a la ultima celda de datos estaticos:
   apila(1+numNiveles+tamDatos)  ||// +1: display 0
   desapila-dir(0)
ffun
cons longInicio = 4
\end{lstlisting}

Ejemplo: inicio(2,5)

Dibujo del movimiento del cp

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Ejemplo de invocación}

\begin{columns}[T]
\column{.5\textwidth}
\begin{lstlisting}[style=codigo]
	tipo tpar= rec x:num; y:num;
	@red@proc distanciaEuclidea(p1:tpar, p2:tpar, var res:num)
	    a: num; b: num;@
	    @blue@proc sumacuadrado(a:num, b:num, var r:num)
            a:=a*a;
	        b:=b*b
	        r:=a+b;@
	    @green@proc raizcuadrada(var n:num)
	        ...@
	    @red@&
	    a:=p1.x-p2.x;
	    b:=p1.y-p2.y;
	    sumacuadrado(a, b, res);
	    raizcuadrada(res);@
	par1:tpar; par2:tpar; resultado:num;
	&
	par1.x:=1; par1.y:=5;
	par2.x:=8; par2.y:=12;
	distanciaEuclidea(par1,par2,resultado);
\end{lstlisting}
\column{.5\textwidth}
	\uncover<2->{
			\Tree
			[.main()
			    [.{\color{red}distanciaEuclidea()}
			        [.{\color{blue}sumaCuadrado()}  ]
			        [.{\color{green}raizCuadrada()} ]
			    ]
			]
	}
\end{columns}
\uncover<1->{¿Cual es el máximo nivel de anidamiento para éste programa?}
\uncover<2->{2}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Esquema de la traducción de subprogramas}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Esquema de la traducción}

Dibujo de cómo queda la traducción de subprogramas y el main, y el salto con ir-a.

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Manejo de la activación y desactivación I}

dibujo con la explicación de ir-ind

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Manejo de la activación y desactivación II}

orden de la ejecución del código generado

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Prellamada}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Prellamada}

Asociada con la invocación $p(e_1,...,e_k)$:
\begin{enumerate}[<+->]
	\item Guardar en memoria la direccion de retorno
    \item Evaluar y almacenar parámetros de ejecución del procedimiento
    \item Saltar a la dirección de inicio del procedimiento
\end{enumerate}

dibujo de lo que aparece al hacer los pasos


\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Prellamada: Ejemplo}

\begin{lstlisting}[style=codigoMP]
fun apila-ret(ret) devuelve
   // calcular CP+1:
   apila-dir(0)          ||
   apila(1)              ||
   suma                  ||
   // guardar dir retorno:
   apila(ret)            ||
   desapila-ind          ||
ffun
cons longApilaRet = 5
\end{lstlisting}

Ejemplo: apila-ret(0x527) , siendo 0x527 el nº de instrucción.

Dibujo

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Prólogo}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Prólogo I}

Asociado con el prodecimiento $proc \ p(...)$:
\begin{enumerate}[<+->]
	\item Guardar el antiguo valor del display
    \item Actualizar el valor nuevo del display
    \item Reservar espacio para las variables locales
\end{enumerate}

dibujo de lo que aparece al hacer los pasos

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Prólogo II}

\begin{lstlisting}[style=codigoMP,basicstyle=\scriptsize\ttfamily]
fun prologo(nivel,tamlocales) devuelve
   // salvar display antiguo:
   apila-dir(0)          ||
   apila(2)              ||
   suma                  ||
   apila-dir(1+nivel)    ||
   desapila-ind          ||
   // fijar el display actual:
   apila-dir(0)          ||
   apila(3)              ||
   suma                  ||
   desapila-dir(1+nivel) ||
   // reservar espacio para datos locales:
   apila-dir(0)          ||
   apila(tamlocales+2)   ||
   suma                  ||
   desapila-dir(0)
ffun
cons longPrologo = 13
\end{lstlisting}


\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Prólogo: Ejemplo I}

\begin{lstlisting}[style=codigoMP,basicstyle=\tiny\ttfamily]
fun prologo(nivel,tamlocales) devuelve
   // salvar display antiguo:
   @b@apila-dir(0)          ||@
   @b@apila(2)              ||@ // dir. retorno, antiguo display
   @b@suma                  ||@
   @b@apila-dir(1+nivel)    ||@ // +1: saltar al display 0
   @b@desapila-ind          ||@
   // fijar el display actual:
   apila-dir(0)          ||
   apila(3)              ||
   suma                  ||
   desapila-dir(1+nivel) ||
   // reservar espacio para datos locales:
   apila-dir(0)          ||
   apila(tamlocales+2)   ||
   suma                  ||
   desapila-dir(0)
ffun
\end{lstlisting}

Ejemplo: prologo(1,7)

Dibujo

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Prólogo: Ejemplo II}

\begin{lstlisting}[style=codigoMP,basicstyle=\tiny\ttfamily]
fun prologo(nivel,tamlocales) devuelve
   // salvar display antiguo:
   apila-dir(0)          ||
   apila(2)              ||
   suma                  ||
   apila-dir(1+nivel)    ||
   desapila-ind          ||
   // fijar el display actual:
   @b@apila-dir(0)          ||@
   @b@apila(3)              ||@
   @b@suma                  ||@
   @b@desapila-dir(1+nivel) ||@
   // reservar espacio para datos locales:
   apila-dir(0)          ||
   apila(tamlocales+2)   ||
   suma                  ||
   desapila-dir(0)
ffun
\end{lstlisting}

Ejemplo: prologo(1,7)

Dibujo

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Prólogo: Ejemplo III}

\begin{lstlisting}[style=codigoMP,basicstyle=\tiny\ttfamily]
fun prologo(nivel,tamlocales) devuelve
   // salvar display antiguo:
   apila-dir(0)          ||
   apila(2)              ||
   suma                  ||
   apila-dir(1+nivel)    ||
   desapila-ind          ||
   // fijar el display actual:
   apila-dir(0)          ||
   apila(3)              ||
   suma                  ||
   desapila-dir(1+nivel) ||
   // reservar espacio para datos locales:
   @b@apila-dir(0)          ||@ // Mem[1+nivel] = Pila[Cima]
   @b@apila(tamlocales+2)   ||@ // +2: dir. retorno, antiguo display
   @b@suma                  ||@
   @b@desapila-dir(0)         @
ffun
\end{lstlisting}

Ejemplo: prologo(1,7)

Dibujo

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Epílogo}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Epílogo I}

Asociado con el prodecimiento $proc \ p(...)$:
\begin{itemize}[<+->]
	\item Almacenar el valor devuelto por la función (en nuestro caso no se hace, no tenemos funciones)
\end{itemize}
\begin{enumerate}[<+->]
    \item Liberar el espacio utilizado por las variables locales (mover hacia atrás el CP)
    \item Restaurar el antiguo display
    \item Apilar la dirección de retorno y saltar usando \emph{ir-ind}
\end{enumerate}

dibujo de lo que aparece al hacer los pasos

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Epílogo II}
\begin{lstlisting}[style=codigoMP,basicstyle=\scriptsize\ttfamily]
fun epilogo(nivel) devuelve
   // apilar la dir. retorno:
   apila-dir(1+nivel)    ||
   apila(2)              ||
   resta                 ||
   apila-ind             ||
   // liberar espacio (mover CP):
   apila-dir(1+nivel)    ||
   apila(3)              ||
   resta                 ||
   copia                 ||
   desapila-dir(0)       ||
   // recupear antiguo display:
   apila(2)              ||
   suma                  ||
   apila-ind             ||
   desapila-dir(1+nivel)
ffun
cons longEpilogo = 13
\end{lstlisting}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Epílogo: Ejemplo I}

\begin{lstlisting}[style=codigoMP,basicstyle=\tiny\ttfamily]
fun epilogo(nivel) devuelve
   // apilar la dir. retorno:
   @b@apila-dir(1+nivel)    ||@
   @b@apila(2)              ||@
   @b@resta                 ||@
   @b@apila-ind             ||@
   // liberar espacio (mover CP):
   apila-dir(1+nivel)    ||
   apila(3)              ||
   resta                 ||
   copia                 ||
   desapila-dir(0)       ||
   // recupear antiguo display:
   apila(2)              ||
   suma                  ||
   apila-ind             ||
   desapila-dir(1+nivel)
ffun
\end{lstlisting}

Ejemplo: epilogo(1)

Dibujo

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Epílogo: Ejemplo II}

\begin{lstlisting}[style=codigoMP,basicstyle=\tiny\ttfamily]
fun epilogo(nivel) devuelve
   // apilar la dir. retorno:
   apila-dir(1+nivel)    ||
   apila(2)              ||
   resta                 ||
   apila-ind             ||
   // liberar espacio (mover CP):
   @b@apila-dir(1+nivel)    ||@
   @b@apila(3)              ||@
   @b@resta                 ||@
   @b@copia                 ||@ // si no se usa copia, hay que mover CP lo ultimo
   @b@desapila-dir(0)       ||@
   // recupear antiguo display:
   apila(2)              ||
   suma                  ||
   apila-ind             ||
   desapila-dir(1+nivel)
ffun
\end{lstlisting}

Ejemplo: epilogo(1)

¿Es la mejor forma de implementar el epílogo, con mover el CP en 2º lugar?

Dibujo

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Epílogo: Ejemplo III}

\begin{lstlisting}[style=codigoMP,basicstyle=\tiny\ttfamily]
fun epilogo(nivel) devuelve
   // apilar la dir. retorno:
   apila-dir(1+nivel)    ||
   apila(2)              ||
   resta                 ||
   apila-ind             ||
   // liberar espacio (mover CP):
   apila-dir(1+nivel)    ||
   apila(3)              ||
   resta                 ||
   copia                 ||
   desapila-dir(0)       ||
   // recupear antiguo display:
   @b@apila(2)              ||@
   @b@suma                  ||@
   @b@apila-ind             ||@
   @b@desapila-dir(1+nivel)   @
ffun
\end{lstlisting}

Ejemplo: epilogo(1)

Dibujo

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Postllamada}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Postllamada}

\begin{itemize}[<+->]
	\item No es necesaria en nuestra implementación, ya que el epílogo recupera el estado anterior a la invocación
	\item Hemos terminado con la dirección (indirecta) de retorno en la cima de la pila
\end{itemize}
\uncover<+->{En otras arquitecturas:}
\begin{itemize}[<+->]
	\item Soportan funciones con retorno de valor: copiar el valor devuelto por la función donde sea necesario
	\item $x86,x86\_64,ARM$ \ldots: restaurar el estado (registros, diferentes punteros)\ldots
\end{itemize}

dibujo de la cima de la pila

dibujo de la memoria

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Resumen}

repetir dibujo del manejo de la activacion y la desactivacion

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Paso de parámetros}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Paso de parámetros}

\begin{itemize}[<+->]
	\item Las posiciones de los parámetros en el reg. de activación son relativas al \emph{CP}
	\item Durante la prellamada, el \emph{CP} apunta a la celda anterior a la primera del reg. de activación
	\item Por lo tanto, los parámetros y variables locales empezarán a partir de \emph{CP} + 3
	\item Sus direcciones deben precalcularse en ejecución (antes de ejecutar el método) y guardarse en la TS
\end{itemize}

\uncover<+->{¿Por qué deben precalcularse en ejecución?}
\uncover<+->{Por que el \emph{CP} se va moviendo y dejan de ser accesibles}

dibujo del registro de activación con CP +3 y CP+4

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Por valor}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Paso de parámetros por valor}

Dos formas:
\begin{enumerate}[<+->]
	\item modo \textbf{var}: proc1(\textbf{x});
	\item modo \textbf{val}: proc1(\textbf{3}); ó proc1(\textbf{x+1}); ó proc1(\textbf{3+4});\\
	Es decir, si pasa por la pila de evaluación, es de tipo \textbf{val}
\end{enumerate}

\uncover<+->{¿Que se hace en nuestra arquitectura?}
\begin{enumerate}[<+->]
	\item modo \textbf{var}: se copia el valor en el
registro de activación (instrucción mueve)
	\item modo \textbf{val}: la cima de la pila de
evaluación contendrá el valor de la expresión. Debemos desapilar el valor en el registro de activación
\end{enumerate}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Paso de parámetros por valor: Gramática}

\textbf{var} es sólo para Mem. Las reglas que tienen operadores su modo es \textbf{val} ya que devuelven un tipo fijo (\emph{true, false, number})

\begin{columns}[T]
\column{.5\textwidth}
	\begin{lstlisting}[style=gramaticas,basicstyle=\footnotesize\ttfamily]
	Fact ::= Mem
	   Fact.modo = @green@var@
	Fact ::= num
	   Fact.modo = @b@val@
	Fact ::= true
	   Fact.modo = @b@val@
	Fact ::= false
	   Fact.modo = @b@val@
	Fact ::= ( Exp )
	   Fact.modo = Exp.modo
	Term ::= Term OpMul Fact
	   Term0.modo = @b@val@
	\end{lstlisting}

\column{.5\textwidth}
	\begin{lstlisting}[style=gramaticas,basicstyle=\footnotesize\ttfamily]
	Term ::= Fact
	   Term . modo = Fact.modo
	ExpS ::= ExpS OpAd Term
	   ExpS.modo = @b@val@
	ExpS ::= ExpS or Term
	   ExpS.modo = @b@val@
	ExpS ::= Term
	   ExpS.modo = Term.modo
	Exp ::= ExpS OpComp ExpS
	   Exp.modo = @b@val@
	Exp ::= ExpS
	   Exp.modo = ExpS.modo
	Term ::= Term and Fact
	   Term0.modo = @b@val@
	\end{lstlisting}

\end{columns}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Paso de parámetros por valor: var I}

\begin{itemize}
	\item modo \textbf{var}: se copia el valor en el
registro de activación (instrucción mueve, que copia un trozo de código a otras posiciones de memoria)
\end{itemize}

\begin{lstlisting}[style=codigo,basicstyle=\footnotesize\ttfamily]
@bold@par1:tpar; par2:tpar;@ & resultado:num;
&
par1.x:=1; par1.y:=5; par2.x:=8; par2.y:=12;
@bold@distanciaEuclidea(par1,par2@,resultado);
\end{lstlisting}

dibujo de los parámetros

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Paso de parámetros por valor: var II}

\begin{itemize}
	\item modo \textbf{var}: se copia el valor en el
registro de activación (instrucción mueve, que copia un trozo de código a otras posiciones de memoria)
\end{itemize}

\begin{lstlisting}[style=codigo,basicstyle=\footnotesize\ttfamily]
@bold@par1:tpar; par2:tpar;@ & resultado:num;
&
par1.x:=1; par1.y:=5; par2.x:=8; par2.y:=12;
@bold@distanciaEuclidea(par1,par2@,resultado);
\end{lstlisting}

dibujo de los parámetros con los de distancia euclidea

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Paso de parámetros por valor: val I}

\begin{itemize}
	\item modo \textbf{val}: la cima de la pila de
evaluación contendrá el valor de la expresión. Debemos desapilar el valor en el registro de activación
\end{itemize}

\begin{lstlisting}[style=codigo,basicstyle=\footnotesize\ttfamily]
@bold@proc distanciaEuclidea(p1:tpar, p2:tpar,@ & res:num)
   ...
   proc sumacuadrado(a:num, b:num, var r:num)
   ...
&
sumacuadro(@blue@3*2@,@blue@7@,res);
\end{lstlisting}

dibujo de los parámetros con un 6 en la pila

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Paso de parámetros por valor: val II}

\begin{itemize}
	\item modo \textbf{val}: la cima de la pila de
evaluación contendrá el valor de la expresión. Debemos desapilar el valor en el registro de activación
\end{itemize}

\begin{lstlisting}[style=codigo,basicstyle=\footnotesize\ttfamily]
@bold@proc distanciaEuclidea(p1:tpar, p2:tpar,@ & res:num)
   ...
   proc sumacuadrado(a:num, b:num, var r:num)
   ...
&
sumacuadro(@blue@3*2@,@blue@7@,res);
\end{lstlisting}

dibujo de los parámetros con un 7 en la pila

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Por variable}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Paso de parámetros por variable}

\begin{itemize}[<+->]
	\item En la cima de la pila debe estar la dirección de comienzo de la variable pasada como parámetro. Dicha dirección se copia en el registro de activación
	\item En la evaluación de las expresiones debe retardarse el apilado de los valores de las direcciones para Mem
\end{itemize}

\uncover<+->{¿Cómo sabe el procemiento que ha sido por \textbf{variable (\&)}, y lo que hay en el registro de activación es una dirección de mem.?}
\uncover<+->{Se accede con indirección: Display + dir. de la variable de la TS}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Paso de parámetros por variable I}

\begin{itemize}
	\item En la cima de la pila debe estar la dirección de comienzo de la variable pasada como parámetro. Dicha dirección se copia en el registro de activación
\end{itemize}

\begin{lstlisting}[style=codigo,basicstyle=\footnotesize\ttfamily]
par1:tpar; par2:tpar; @blue@& resultado:num;@
&
par1.x:=1; par1.y:=5; par2.x:=8; par2.y:=12;
@bold@distanciaEuclidea@(par1,par2,@bold@resultado@);
\end{lstlisting}

dibujo de los parámetros con un 8 en la pila

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Amplicación de la TS}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Paso de parámetros: ampliacion de la TS I}

\begin{itemize}
	\item Deben asignarse direcciones a los parámetros de los procedimientos:
\end{itemize}

\begin{lstlisting}[style=gramaticas,basicstyle=\scriptsize\ttfamily,mathescape]
LFParams ::= LFParams, FParam
   LFParams0.ts = aniadeID(LFParams1.ts,FParam.id,
   FParam.props $\oplus$ @bold@<dir:LFParams1.dir>@)
   LFParams0.dir = LFParams1.dir + FParam.tam
   @bold@FParam.dirh = LFParams1.dir@
LFParam ::= FParam
   LFParam.ts = aniadeID(LFParam.tsph, FParam.id,FParam.props $\oplus$ @bold@<dir:0>@)
   LFParam.dir = FParam.tam
   @bold@FParam.dirh = 0@
FParam ::= & iden: Tipo
   FParam.tam = @bold@1@ // es una direccion: integer.tam = 1
   Fparam.param = <modo: @blue@variable@, tipo: Tipo.tipo, @bold@dir: Fparam.dirh@>
FParam ::= id: Tipo
   FParam.tam = @bold@Tipo.tipo.tam@ // es por valor
   Fparam.param = <modo: @blue@valor@, tipo: Tipo.tipo, @bold@dir: Fparam.dirh@>
\end{lstlisting}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Paso de parámetros: ampliacion de la TS II}

\begin{itemize}
	\item La dirección de comienzo de un bloque de declaraciones no tiene que ser ya necesariamente cero, sino la dirección de fin del bloque de arámetros: las declaraciones reciben una dirección de comienzo heredada
\end{itemize}

\begin{lstlisting}[style=gramaticas,basicstyle=\scriptsize\ttfamily,mathescape]
Prog ::= Decs && Is
   Decs.dirh = 0
DecProc ::= proc iden FParams Bloque fproc
   Bloque.dirh = FParams.dir
FParams ::= ( LFParams )
   FParams.dir = LFParams.dir
FParams ::= $\lambda$
   FParams.dir = 0
Bloque ::= Decs && I
   Decs.dirh = Bloque.dirh // las decs reciben dirheredada
Decs ::= Decs ; Dec
   Decs1.dirh = Decs0.dirh
Decs ::= Dec
   Decs.dir = Decs.dirh + Dec.tam
   Dec.dirh = Decs.dirh
\end{lstlisting}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Paso de parámetros: ampliacion de la TS III}

\tiny
\begin{tabular*}{0.80\textwidth}{|l|l|l|l|}
\textbf{nivel} & \textbf{id}       & \textbf{clase}    & \textbf{otras}                                                                                                                                                                                                                                                        \\ \hline
1              & p1                & var //valor       & $<tipo:<t:ref, id:tpar>, dir:0>$                                                                                                                                                                                                  \\ \hline
1              & p2                & var //valor       & $<tipo:<t:ref, id:tpar>, dir:2>$                                                                                                                                                                                                  \\ \hline
1              & res               & pvar //referencia & $<tipo:<t:num>, dir:4>$                                                                                                                                                                                                           \\ \hline
1              & distanciaEuclidea & prodedimiento     & $<tipo:<t:proc, params: {[}modo:valor{]}, tipo:<tipo:<t:red, id:tpar>{]}{[}modo:valor, tipo:<t:ref, id:tpar>{]}{[}modo:variable, tipo:<t:num>{]}>>>$ \\ \hline
1              & a                 & var //local       & $<tipo:<t:num>, dir:5>$                                                                                                                                                                                                           \\ \hline
1              & b                 & var //local       & $<tipo:<t:num>, dir:6>$                                                                                                                                                                                                           \\ \hline
               &                   & $\vdots$          &                                                                                                                                                                                                                                                                       \\ \hline
1              & sumaCuadrado      & procedimiento     & $<tipo:<t:proc, params: {[}modo:valor{]}, tipo:<tipo:<t:num>{]}{[}modo:valor, tipo:<t:num>{]}{[}modo:variable, tipo:<t:num>{]}>>>$                    \\ \hline
1              & raizCuadrada      & procedimiento     & $<tipo:<t:proc, params: {[}modo:valor{]}, tipo:<t:num>{]}>>$                                                                                                                                                   \\ \hline
\end{tabular*}


Dibujo con los parametros y sus desplazamientos

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Acceso a las variables y parámetros desde el procedimiento}

\begin{itemize}
	\item Desplazamiento relativo al valor del display del bloque en el que reside la variable
	\item Además, si el parámetro es por variable (tipo \emph{pvar}), debe realizarse un apilado indirecto para acceder al enlace en sí
\end{itemize}

\begin{lstlisting}[style=codigoMP,basicstyle=\scriptsize\ttfamily,mathescape]
fun accesoVar(id) devuelve
   apila-dir(1+id.nivel) ||  // dir del display
   apila(id.dir)         ||  // desplazamiento respecto al display
   suma                      // traer dir0valor a Cima
   // aqui nos falta un apila_ind !!!
   ( si id.clase = pvar entonces apila-ind
   si no $\lambda$ )
ffun

fun longAccesoVar(id)
   si id.clase = pvar entonces 4
   si no 3
ffun
\end{lstlisting}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Traducción}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Inicio}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Inicio I}

\begin{itemize}
	\item Al iniciar la traducción, necesitamos reservar espacio para los displays
	\item Para ello, usamos la función \emph{inicio()}
\end{itemize}

\begin{lstlisting}[style=codigoMP,basicstyle=\scriptsize\ttfamily,mathescape]
fun inicio(numNiveles,tamDatos)
   apila(numNiveles+2)
   desapila-dir(1)
   apila(1+numNiveles+tamDatos)
   desapila-dir(0)
ffun

cons longInicio = 4
\end{lstlisting}

Ejemplo: inicio(2,5)

dibujo de los displays con interrogación

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Inicio II}

\begin{itemize}
	\item Para reservar el espacio, es necesario conocer el nivel de anidamiento, que se sintetiza en las declaraciones:
\end{itemize}

\begin{columns}[T]
\column{.5\textwidth}
	\begin{lstlisting}[style=gramaticas,basicstyle=\scriptsize\ttfamily,mathescape]
	Prog ::= Decs && Is
	   Decs.nh = 0
	Decs ::= Decs ; Dec
	   Decs1.nh = Decs0.nh
	   Decs0.n = @bold@max(Decs1.n,Dec.n)@
	Decs ::= Dec
	   Dec.nh = Decs.nh
	   Decs.n = Dec.n
	Dec ::= DecVar
	   Dec.n = Dec.nh
	Dec ::= DecTipo
	   Dec.n = Dec.nh
	Dec ::= DecProc
	   DecProc.nh = Dec.nh
	   Dec.n = DecProc.n
	\end{lstlisting}

\column{.5\textwidth}
	\begin{lstlisting}[style=gramaticas,basicstyle=\scriptsize\ttfamily,mathescape]
	DecProc ::= proc iden FParams Bloque fproc
	   FParams.nh = Bloque.nh = @bold@DecProc.nh + 1@
	   DecProc.n = Bloque.n
	Bloque ::= Decs && I
	   Decs.nh = Bloque.nh
	   Bloque.n = Decs.n
	Bloque ::= I
	   Bloque.n = Bloque.nh
	\end{lstlisting}
\end{columns}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Inicio III}

\begin{itemize}
	\item Conocido el tamaño de los displays, la traducción del programa se especifica como:
\end{itemize}

\begin{columns}[T]
\column{.5\textwidth}
	\begin{lstlisting}[style=gramaticas,basicstyle=\scriptsize\ttfamily,mathescape]
	Prog ::= Decs && Is
	   Proc.cod = @bold@inicio(Decs.n,Decs.dir)@ || // Decs.dir: tam del main
	   @bold@ir-a(Decs.etq)@                     ||
	   Decs.cod                           || // aqui van los procs.
	   Is.cod                             ||
	   stop
	   Decs.etqh = longInicio +1 // +1: ir-a
	   Is.etqh = Decs.etq
	\end{lstlisting}

\column{.5\textwidth}
	\uncover<+->{dibujo del ir-a para que se den cuenta de que hay q parchear}
\end{columns}

\uncover<+->{¿Hay que parchear?\\}
\uncover<+->{Sí, para apuntar al main, del cual no sabemos su dirección todavía}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Declaraciones}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Declaraciones}

\begin{lstlisting}[style=gramaticas,basicstyle=\scriptsize\ttfamily,mathescape]
Prog ::= Decs && Is
Decs ::= Decs ; Dec
   Decs1.etqh = Decs0.etqh
   Dec.etqh = Decs1.etq
   Decso.etq = Dec.etq
   Decs0.cod = Decs1.cod || Dec.cod
Decs ::= Dec
   Dec.etqh = Decs.etqh
   Decs.etq = Dec.etq
   Decs.cod = Dec.cod
Dec ::= DecVar
   Dec.cod = @bold@$\lambda$@ // solo afecta a la TS
   Dec.etq = Dec.etqh
Dec ::= DecTipo
   Dec.cod = @bold@$\lambda$@ // solo afecta a la TS
Dec.etq = Dec.etqh
\end{lstlisting}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Procedimientos}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Procedimientos I}

\begin{itemize}
	\item Al traducir un procedimiento añadimos a la TS su dirección de inicio (para luego realizar el salto en la invocación)
\end{itemize}

\begin{lstlisting}[style=gramaticas,basicstyle=\scriptsize\ttfamily,mathescape]
Dec ::= DecProc
   DecProc.etqh = Dec.etqh
   Dec.etq = DecProc.etq
   Dec.cod = DecProc.cod
   Dec.propsop = @bold@DecProc.propsop@ // hay que parchear

DecProc ::= proc iden FParams Bloque fproc
   DecProc.cod = Bloque.cod
   DecProc.propsop = @bold@<inicio:Bloque.inicio>@ // Bloque.inicio: dir donde empieza el proc.
   Bloque.etqh = DecProc.etqh
   DecProc.etq = Bloque.etq
   Bloque.tsph = aniadeID(FParams.ts, DecProp.id,
   	             DecProc.props $\oplus$ {nivel:DecsProp.nh +1}
                 $\oplus$ @bold@DecProc.propsop@)
\end{lstlisting}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Procedimientos II}

\begin{tabular*}{0.80\textwidth}{|l|l|l|l|}
\textbf{nivel} & \textbf{id}       & \textbf{clase}    & \textbf{otras}                                                                                                                                                                                                                                                        \\ \hline
0              & tpar              & tipo              & $<tipo:<t:rec, campos:[id:x,tipo:<t:num>,desp:0][id:y,tipo:<t:num>,desp:1]>, tam:2>$      \\ \hline
0              & par1              & var //valor       & $<tipo:<t:ref, id:tpar>>$                                                                 \\ \hline
0              & par2              & var //valor       & $<tipo:<t:ref, id:tpar>>$                                                                 \\ \hline
1              & resultado         & pvar //referencia & $<tipo:<t:num>>$                                                                          \\ \hline
1              & distanciaEuclidea & prodedimiento     & $<tipo:<t:proc, params: [modo:valor, tipo:<t:ref,id:tpar>][modo:valor,tipo:<t:ref,id:tpar>][modo:variable,tipo:<t:num>]>inicio:6>$ \\ \hline
\end{tabular*}


inicio: Dir de la 1ºa instrucción (despues de \emph{Decs})

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Bloque de código del proc.}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Bloque de código del proc.}

\begin{lstlisting}[style=gramaticas,basicstyle=\scriptsize\ttfamily,mathescape]
Bloque ::= Decs && I
   Decs.etqh = Bloque.etqh
   @bold@Bloque.inicio@ = Decs.etq
   I.etqh = Decs.etq + longPrologo
   Bloque.etq = I.etq + longEpilogo + 1
   @bold@Bloque.cod = Decs.cod || prologo(Bloque.nh, Decs.dir) ||
                I.cod                                    ||
                epilogo(Bloque.nh )                      ||
                ir-ind@
Bloque ::= I
   @bold@Bloque.cod = prologo(Bloque.nh, Bloque.dirh ) ||
                I.cod                            ||
                epilogo(Bloque.nh )              ||
                ir-ind@
   I.etqh = Bloque.etqh + longPrologo
   Bloque.inicio = Bloque.etqh
   Bloque.etq = I.etq + longEpilogo + 1
\end{lstlisting}

	dibujo con punteros a inicio y etqh y etq


\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Invocaciones}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Invocaciones I}

\begin{lstlisting}[style=gramaticas,basicstyle=\scriptsize\ttfamily,mathescape]
I ::= ICall
   ICall.etqh = I.etqh
   I.etq = ICall.etq
   I.cod = ICall.cod
ICall ::= iden AParams
   @bold@ICall.cod = // Prellamada:
               apila-ret(ICall.etq) || // parchear a despues de proc
               AParams.cod          || // cod de '3+a'
               ir-a(ICall.tsh [iden.lex].inicio)@
   AParams.etqh = Icall.etqh + longApilaRet
   ICall.etq = AParams.etq +1// +1: ir-a
AParams ::= LAparams
   AParams.cod = @bold@inicio-paso || LAParams.cod || fin-paso@
   LAParams.etqh = AParams.etqh + longInicioPaso
   AParams.etq = LAParams.etq + longFinPaso
\end{lstlisting}

	dibujo con punteros a inicio y etqh y etq


\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Invocaciones II (paso parámetros)}

\begin{itemize}
	\item El inicio del paso de parámetros apila la dirección de comienzo de los parámetros en el display: \emph{CP} + 3
\end{itemize}

\begin{lstlisting}[style=codigoMP,basicstyle=\scriptsize\ttfamily,mathescape]
cons inicio-paso = apila-dir(0x0) || // apila el CP
                   apila(3)       || // salta ret, display antiguo
                   suma
cons longInicioPaso = 3
\end{lstlisting}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Invocaciones II (paso parámetros)}

\begin{itemize}
	\item El inicio del paso de parámetros apila la dirección de comienzo de los parámetros en el display: \emph{CP} + 3
\end{itemize}

\begin{lstlisting}[style=codigoMP,basicstyle=\scriptsize\ttfamily,mathescape]
cons inicio-paso = apila-dir(0x0) || // apila el CP
                   apila(3)       || // salta ret, display antiguo
                   suma
cons longInicioPaso = 3
\end{lstlisting}

\begin{itemize}
	\item Este valor permanece en la pila para ser utilizado por cada parámetro (que lo copiará)
\end{itemize}

\begin{itemize}
	\item Por lo tanto, el fin del paso de parámetros simplemente desapila la dirección de comienzo de los parámetros
\end{itemize}

\begin{lstlisting}[style=codigoMP,basicstyle=\scriptsize\ttfamily,mathescape]
cons fin-paso = desapila
cons longFinPaso = 1
\end{lstlisting}

dibujo de pilas

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Invocaciones III (paso parámetros, func. auxiliares)}

\begin{itemize}
	\item Función para obtener la dirección de un parámetro en el registro de activación
\end{itemize}

\begin{lstlisting}[style=codigoMP,basicstyle=\scriptsize\ttfamily,mathescape]
fun direccionParFormal(pformal) devuelve
   apila(pformal.dir) || // dir relativa al procedimiento
   suma
ffun
fun longdireccionParFormal(pformal) devuelve 2 ffun
\end{lstlisting}

dibujo de pilas

\begin{itemize}
	\item Función para realizar el paso de los parámetros
\end{itemize}

\begin{lstlisting}[style=codigoMP,basicstyle=\scriptsize\ttfamily,mathescape]
fun pasoParametro(tipoParamPorValor,pformal) devuelve
   si pformal.modo = val $\wedge$ tipoParamPorValor = var
       // hay que apilar dir de origen del parametro. Se hace mas adelante en accesoVar()
       mueve(pformal.tipo.tam) // copia del valor en el caso de expr. mem
   si no desapila-ind          // copia del valor,0bien de la direcc.
ffun
fun longPasoParametro(tipoParamPorValor,pformal) devuelve1ffun
\end{lstlisting}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Invocaciones IV}


\begin{lstlisting}[style=gramaticas,basicstyle=\scriptsize\ttfamily,mathescape]
AParams ::= $\lambda$
   AParams.cod = $\lambda$
   AParams.etq = AParams.etqh
LAParams ::= LAParams, Exp
   @bold@LAParams0.cod = LAParams1.cod        ||
                   copia                ||
                   direccionParFormal(
                   	    LAParams0.fparams[LAParams0.nparams]
                   	    )               ||
                   Exp.cod              ||
                   pasoParametro(Exp.modo,
                            LAParams0.fparams[LAParams0.nparams])@
   LAParams1.etqh = LAParams0.etqh
   Exp.etqh = LAParams1.etq+1
   LAParams0.etq = Exp.etq +1+
                   longDireccionParFormal(
                   	        LAParams0.fparams[LAParams0.nparams])+
                   longPasoParametro(Exp.modo, LAParams0.fparams[LAParams0.nparams])
\end{lstlisting}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Invocaciones V}


\begin{lstlisting}[style=gramaticas,basicstyle=\scriptsize\ttfamily,mathescape]
LAParams ::= Exp
   @bold@LAParams.cod = copia   ||
                  Exp.cod ||
                  pasoParametro(Exp.modo,LAParams.fparams[1])@
   Exp.etqh = LAParams.etq+1
   LAParams.etq = Exp.etq +1+
                  longPasoParametro(Exp.modo, LAParams.fparams[1])
\end{lstlisting}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Modificación en la traducción}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Modificación en la trad. de expresiones I}

\begin{itemize}
	\item Problema con el paso de parámetros por variable:
		\begin{itemize}
			\item En la cima de la pila debe de estar la dirección de comienzo de la variable pasada como parámetro. Dicha dirección se copia en el registro de activación
		\end{itemize}
	\item Sin embargo, en las expresiones \emph{Mem} hay un \emph{apila-ind} que deja su valor (no la dirección) en la cima
\end{itemize}

\begin{lstlisting}[style=codigo,basicstyle=\footnotesize\ttfamily]
par1:tpar; par2:tpar; @bold@& resultado:num;@
&
par1.x:=1; par1.y:=5; par2.x:=8; par2.y:=12;
@bold@distanciaEuclidea@(par1,par2,@bold@resultado@);
\end{lstlisting}

Dibujo pila 0x8 y como va a la direccion 11


\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Modificación en la trad. de expresiones II}

\textbf{Solución}:
\begin{itemize}
	\item Debe evitarse cargar adelantadamente el valor de las posiciones de memoria cuando éstas aparecen como parámetros reales
	\item A fin de no modificar el esquema de generación de código de las expresiones y asignación, la solución menos intrusiva es determinar si el contexto de ocurrencia de un designador (derivado de \emph{Mem}) es como parámetro real: atributo heredado \emph{parh}
\end{itemize}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Modificación en la trad. de expresiones III}

\begin{columns}[T]
\column{.5\textwidth}
	\begin{lstlisting}[style=gramaticas,basicstyle=\footnotesize\ttfamily]
	Exp ::= ExpS OpComp ExpS
	   ExpS0.parh = ExpS1.parh = false
	Exp ::= ExpS
	   ExpS.parh = Exp.parh
	ExpS ::= ExpS OpAd Term
	   ExpS1.parh = Term.parh = false
	ExpS ::= ExpS or Term
	   ExpS1.parh = Term.parh = false
	\end{lstlisting}
\column{.5\textwidth}
	\begin{lstlisting}[style=gramaticas,basicstyle=\footnotesize\ttfamily]
	ExpS ::= Term
	   Term.parh = ExpS.parh
	Term.parh = ExpS.parh
	Term ::= Term OpMul Fact
	   Term1.parh = Fact.parh = false
	Term ::= Term and Fact
	   Term1.parh = Fact.parh = false
	Term ::= Fact
	   Fact.parh = Term.parh
	Fact ::= (Exp)
	   Exp.parh	= Fact.parh
	Fact ::= OpUn Fact
	   Fact1.parh = false
	\end{lstlisting}
\end{columns}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Modificación en la trad. de expresiones IV}

\begin{itemize}
	\item Los valores iniciales deben fijarse allí donde pueda aparecer una expresión:
\end{itemize}

\begin{lstlisting}[style=gramaticas,basicstyle=\footnotesize\ttfamily]
IAsig ::= Mem := Exp
   Exp.parh = false
IIf ::= if Exp then I PElse
   Exp.parh = false
IWhile ::= while Exp do I PElse
   Exp.parh = false
LAParams ::= LAParams,Exp
   Exp.parh = (LAParams0.fparamsh[LAParams0.nparams].modo == var)
LAParams ::= Exp
   Exp.parh = (LAParams0.fparamsh[1].modo == var)
\end{lstlisting}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Modificación en la trad. de expresiones V}

\begin{itemize}
	\item Ahora la generación de código para \emph{Mem} puede modificarse como sigue:
\end{itemize}

\begin{lstlisting}[style=gramaticas,basicstyle=\footnotesize\ttfamily,mathescape]
Fact ::= Mem
   Fact.cod = si compatible(Mem.tipo,<t:num>,Fact.tsh ) $\lor$
                 compatible(Mem.tipo,<t:bool>,Fact.tsh ) $\land$
                 @bold@$\neg$ Fact.parh@
              entonces
                  @bold@Mem.cod || apila-ind@ // Por valor
              si no @bold@Mem.cod@            // Por variable
Fact.etq = si compatible(Mem.tipo,<t:num>,Fact.tsh ) $\lor$
              compatible(Mem.tipo,<t:bool>,Fact.tsh ) $\land$
              $\neg$ Fact.parh
           entonces
              Mem.etq + 1
           si no Mem.etq
\end{lstlisting}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Modificación en la trad. de expresiones VI}

\begin{itemize}
	\item El otro aspecto a modificar es el acceso a los identificadores: ahora debe computarse adecuadamente el enlace a los mismos:
\end{itemize}

\begin{lstlisting}[style=gramaticas,basicstyle=\footnotesize\ttfamily,mathescape]
Mem ::= id
   Mem.cod = @bold@accesoVar@(Mem.tsh [id.lex])
   Mem.etq = Mem.etqh + @bold@longAccesoVar@(Mem.tsh [id.lex])
\end{lstlisting}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Acceso a variables y parámetros}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Acceso a las variables y parámetros desde el proc. I}

\begin{itemize}
	\item Desplazamiento relativo al valor del display del bloque en el que reside la variable
	\item Además, si el parámetro es por variable (tipo \emph{pvar}), debe realizarse un apilado indirecto para acceder al enlace en sí
\end{itemize}

\begin{lstlisting}[style=codigoMP,basicstyle=\footnotesize\ttfamily,mathescape]
fun accesoVar(id) devuelve
   apila-dir(1+id.nivel) ||
   apila(id.dir)         ||
   suma
   ( si id.clase = pvar entonces apila-ind
   si no $\lambda$ )
ffun

fun longAccesoVar(id) devuelve
   si id.clase = pvar entonces 4
   si no 3
ffun
\end{lstlisting}

\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Traducción: Acceso a las variables y parámetros desde el proc. II}

tabla

dibujo con a y b y los desplazamientos, y el cp apuntando a 17 y el display a 11

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Recapitulación}
	\scriptsize\tableofcontents
\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}[fragile]
\frametitle{Preguntas}
	\begin{center}
	\fontsize{100}{120}{\selectfont ?}
	\end{center}
\end{frame}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{document}
